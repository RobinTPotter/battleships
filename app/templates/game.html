{% extends "layout.html" %}

{% block moremeta %}
<meta http-equiv="cache-control" content="max-age=0">
<meta http-equiv="cache-control" content="no-cache">
{% endblock %}


{% block content %}

<style>

{# table {  border-collapse: collapse } #}
table {  border-spacing: {{ game.border_spacing }}px; border: none; table-layout: fixed; }
td, tr { border: none; margin: 0; padding: 0 }
{# div.boat { border: 1px black solid; }#}
td  { width:{{ game.cell_size }}px; height:{{ game.cell_size }}px; }
.water { background-color: cyan }
.miss { background-color: yellow }
.hit { background-color: red }
.boat { background-color: grey }
.ui-draggable-dragging { background-color: green }

</style>
Stage: <span id="game_stage">{{ game.stage() }}</span>
<span id="whose_turn"></span>
<div id="myboard" style="display:inherit">
    <h2>{{current_user.id}}</h2>
    <div>
        <div id="sea">
            <table id="seabed"  class="sea">
                {% for row in game.show_board(current_user.id) %}
                {% set r=loop.index - 1 -%}
                    <tr class="sea">
                         {%- for col in row -%}
                        <td id="you_c{{loop.index - 1 }}r{{r}}" class="{{ col }} seablock sea"></td>
                         {%- endfor -%}
                    </tr>
                {%- endfor %}
            </table>
        </div>
        {% if game.stage() == 'setup' %}
        <div id="boats">
        </div>
        {% endif %}
    </div>
</div>

<div id="theirboard" style="display:none">
    <h2 id="opponents_name">{{ game.opponent(current_user.id) }}</h2>
    <table>
        {% for row in game.show_opponent_view_board(current_user.id) %}
        {% set r=loop.index -%}
        <tr>
             {%- for col in row -%}
            <td id="opp_c{{loop.index}}r{{r}}" class="{{ col }}"></td>
             {%- endfor -%}
            </tr>
        {%- endfor %}
    </table>
</div>
<br />
<form>
<input type="button" value="swap" onclick="swap()"></input>
<input type="button" value="ping" onclick="ping()"></input>
<input type="button" value="ready" onclick="ready('{{ current_user.id }}','{{ game.id }}')"></input>
</form>
<div id="output">poo</div>


<script src="{{ url_for('static', filename='lib/socket-io/socket.io.min.js')}}"></script>
<script src="{{ url_for('static', filename='lib/d3/d3.v4.min.js')}}"></script>
<script src="{{ url_for('static', filename='battleships.js')}}?{{ game.id }}"></script>
<script>

//document.addEventListener('mousedown', function(e) { document.getElementById('output').innerHTML='md '+e; console.log(e) })
//document.addEventListener('mousemove', function(e) { document.getElementById('output').innerHTML='mm '+e })
//document.addEventListener('touchstart', function(e) { document.getElementById('output').innerHTML='ts '+e })
//document.addEventListener('touchmove', function(e) { document.getElementById('output').innerHTML='tm '+e })
//document.addEventListener('touchend', function(e) { document.getElementById('output').innerHTML='te '+e })

$(function() {


    var boats_data = {{ game.get_game_player(current_user.id).get_boats() | safe }}
    var boat = d3.select('#boats').selectAll('.boat').data(boats_data)
    var boatEnter = boat.enter().append('div')
    
    boatEnter.attr('id', function(d,i) { return d.name })
        .attr('class', 'boat dragboat')
        .style('position', 'absolute')
        .style('width', function(d,i) { return `${d.width * {{ game.cell_size }} + (d.width - 1) * {{ game.border_spacing }} }px` })
        .style('height', function(d,i) { return `${d.height * {{ game.cell_size }} + (d.height - 1) * {{ game.border_spacing }} }px` })
        .on('mousedown', function(d,i) { console.log(d,i,'down',d3.event); d.dragging = false })
        .on('mouseup', function(d,i) { console.log(d,i,'up',d3.event) })


    $( ".dragboat" ).draggable(
        { "snap": ".seablock",
            "snapMode": "inner",
            "containment": "table.sea",
            "drag": function(event,ui) {
                var p = $('#seabed').position()
                var r = Math.round((ui.offset.top - p.top) / {{ game.cell_size }}) + 1
                var c = Math.round((ui.offset.left - p.left) / {{ game.cell_size }}) + 1
                var ah = Number(event.target.style.height.replace(/[^0-9]*/g,''))
                var aw = Number(event.target.style.width.replace(/[^0-9]*/g,''))
                var h = Math.round(( ah - 2 ) /{{ game.cell_size }})
                var w = Math.round(( aw - 2) /{{ game.cell_size }})
                //console.log(ui,event.target,c,r,w,h,aw,ah)
                event.target.id=`boat_c${c}r${r}w${w}h${h}aw${aw}ah${ah}`  
                var blob = d3.select(`#${event.target.id}`).datum()
                blob.dragging = true
                d3.select(`#${event.target.id}`).datum( blob )
                console.log(d3.select(`#${event.target.id}`).datum())
            }
        }
    );


    //$( ".dragboat" ).doubletap(function() { alert('taptap')})
    $( ".boat" ).bind('mouseup',function() { 
var blob = d3.select(`#${event.target.id}`).datum()
                if (blob.dragging==true) return
        var text = event.target.id.replace(/[^0-9]/g," ").replace(/\s\s+/g, ' ').trim().split(' ')
        //console.log(text)

        var c = text[0]
        var r = text[1]
        var w = text[2]
        var h = text[3]
        var aw = text[4]
        var ah = text[5]

        //console.log(c,r,w,h,aw,ah)

        //rotate
        event.target.style.height = aw+'px'
        event.target.style.width = ah+'px'

        //account for rotation danger, these are swapped
        event.target.id=`boat_c${c}r${r}w${h}h${w}aw${ah}ah${aw}`
       
        
        
    })
});


</script>
{% endblock %}

